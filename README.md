# Calimero Wireshark Hex Dump
A tool to listen on a KNX bus via TPUART and the Calimero Project suite and to dump the data from the packets into a Wireshark-compatible hex dump.


# Prerequisites

This tool is designed to work with the Calimero Java library and is compatible with a Raspberry Pi 3 or 4 and a Raspberry Pi HAT for the TPUART connection.

Here are some guides to getting the environment setup:

  1. [KNX Raspberry PiHAT Usage Walkthrough](/KNX-Raspberry-Pi-Hat-Usage/README.md)
  2. [Raspberry Pi and Calimero Suite Setup](/Raspberry-Pi-Calimero-Setup/README.md)
  
_Note: The next steps will assume that you setup your environment according to these guides._

# Usage
  
  ## Creating the Hex Dump
  1. Place the "Insert hex-dump-source filename here" file into the _introduction/src/main/java/_ folder from the Calimero Project suite.

      Place image here

  3. Change into the _introduction_ folder.
      
      Place cd command image?

  3. To run the program, you can simply run:
      ```
      ./gradlew run -Pcalimero.serial.tpuart.maxInterByteDelay=60000 -Dmainclass=wiresharkTpuartHexDump
      ```
      
  4. Now, you wait for some messages to be transmitted on the bus and the dumped telegrams will be in the _wiresharkHexDumpedTelegrams.txt_ file.

  5. Cancel the tool using Ctrl-C and the file is now ready to be imported into Wireshark to be analyzed.


  ## Analyzing the Hex Dump 
  In Wireshark, you have the ability to import packets from a hex dump and specify a dissector to analyze the packet.
  
  1. Upon starting Wireshark, wait for the initial loading to finish. Then click _File -> Import From Hex Dump..._
      
     [](Wireshark-Import-From-Hex-Dump-Option.png)
      
  2. In order to properly parse this out, we need to give it a regular expression (regex) with some tags.
    
      ```
      ^\s*(?<time>\d{4}-\d\d\-\d\dT(\d\d\:){2}\d\d.(\d){6}[Z])\s(?<seqno>\d{6})\s+(?<data>[0-9a-fA-F]*)$
      ```
  
  3. Choose the hex dump file as the source.
      
  4. Under the new dialog, change to the _Regular Expression_ tab and paste the regex into the box.
  
  5. Ensure that the data encoding is _Plain hex_
  
  6. In the _Timestamp format_ textbox, we need to specify the pattern that is generated by the tool. 
  
      ```
      %Y-%m-%dT%H:%M:%S.%fZ
      ```
      _**NOTE: The timestamp format MUST be the EXACT SAME as this. Otherwise, there will not be a timestamp parsed out.**_
      
  
  7. Under the _Encapsulation_ section, change _Encapsulation Type_ to _Wireshark Upper PDU Export_.
  
  8. Check _ExportPDU_ to specify the _cemi_ dissector.
  
  9. Now you're able to import the file and analyze the telegram.

    [](Wireshark-Full-Hex-Dump-Settings.png)


# Sample Output

Here is a sample output of importing a hex dump generated by this tool.

Insert various pictures of an import and explain the different sections. Also, make note of the UTC normalization and sequence number error.

**Wireshark Timestamp:**
    
    [](Wireshark-Sample-Import-Timestamp.png)

**Corresponding Hex Dump File**

    [](Wireshark-Sample-Hexdump-Timestamp.png)


**Note: The time that is highlighted is the NORMALIZED UTC TIME. No matter what the time-zone next to the time says, it will ALWAYS be the right time in UTC. **
    
    [](Wireshark-Sample-Import-Output.png)

**Considerations:**
    
    1. The cemi dissector starts at the message code (MC) portion of the telegram. It does not take into consideration the medium type.
    2. The reason why the TPCI is highlighted in red is because of a design choice. The dissector will see that the packet is an Unnumbered Data Packet (UDP) which means that the sequence number, according to the KNX standard, is _usually_ set to 0. However, sometimes some devices will set this to a non-zero value. In this case, it was set to 1. The dissector will then check if the sequence number is zero. In this case it is not, thus the error message for the sequence number expecting to be 0. 



